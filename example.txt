Данный пример основан на запросе наших клиентов, которые хотели настроить проверку второго фактора для ssh через единый pam стек.
Sshd может вызывать pam стек двумя способами в режиме paasword и keyboard-interactive. Суть решения в том что, мы настраиваем 
все так, чтобы keyboard-interactive отвечал именно за второй фактор и только за него. Тогда комбинируя keyboard-interactive 
с прочими методам авторизации, мы можем включать и отключать второй фактор.

В sshd_config это будет примерно так:
AuthenticationMethods publickey gssapi-with-mic,keyboard-interactive password,keyboard-interactive
Publickey - не требует второй фактор, gssapi и password требует. Важно понимать, что keyboard-interactive в нашем примере 
отвечает только за второй фактор и применять его нужно только в сочетании с каким нибудь другим методом авторизации. 
Ну конечно, если вы не хотите авторизоваться только вторым факторым без первого.

Общий подход к настройке модуля и стека такой, если наш модуль вернул: success, то значит второй фактор успешно проверен 
и вся авторизация успешна в целом, если модуль вернул: auth_err, то второй фактор проверен и был не успешен как и в целом 
авторизация, если модуль вернул: authinfo_unavail, то это значит, что данный случай нас не касается, проверка авторизации 
лежит на остальном pam стеке.
Настройки нашего модуля будут такими(привожу только значимые параметры):
[general]
#Все сервисы кроме keyboard-interactive будут сразу это возвращать, что будет значить: этот случай меня не касается. 
always_return=authinfo_unavail
[sshd_interactive]
#А вот это уже наша тема и мы отключаем always_return
always_return=none
#Если указаны skip_users или skip_groups, то их надо бы пустить.
skip_result=succes
#Если мы хотим запретить байпасс то auth_err, иначе ставим succes.
#bypass_result=auth_err

А вот примерно как может выглядеть общий стек:
# success - успешно проверен второй фактр и никаких проверок больше не надо
# authinfo_unavail - это не наш случай, pam стек продолжает проверку, 
# как буд-то нашего модуля и не было. Default - Да второй фактор надо было проверить, 
# но либо проверку провалили, либо что-то пошло не так и тогда провал всей проверки.
auth    [success=3 authinfo_unavail=ignore default=2]    pam_mf.so 

# Это фактически дефолтовый стек убунты, сюда можно напихать всего дополнительного.
auth    [success=2 default=ignore]    pam_unix.so nullok
auth    [success=1 default=ignore]    pam_sss.so use_first_pass
auth    requisite            pam_deny.so
auth    required            pam_permit.so
auth    optional            pam_cap.so



 
